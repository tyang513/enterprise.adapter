<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.td.admin.mapper.SysProcessTaskMapper">
  <resultMap id="BaseResultMap" type="com.td.admin.entity.SysProcessTask">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Aug 09 11:00:21 CST 2013.
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="taskConfigId" jdbcType="BIGINT" property="taskConfigId" />
    <result column="taskCode" jdbcType="VARCHAR" property="taskcode" />
    <result column="statusName" jdbcType="VARCHAR" property="statusName" />
    <result column="processname" jdbcType="VARCHAR" property="processname" />
     <result column="candidateuser" jdbcType="VARCHAR" property="candidateuser" />
    <result column="startTime" jdbcType="TIMESTAMP" property="starttime" />
    <result column="endTime" jdbcType="TIMESTAMP" property="endtime" />
    <result column="taskName" jdbcType="VARCHAR" property="taskname" />
    <result column="assignerUmId" jdbcType="VARCHAR" property="assignerumid" />
    <result column="assignerName" jdbcType="VARCHAR" property="assignername" />
    <result column="status" jdbcType="INTEGER" property="status" />
    <result column="processInstanceId" jdbcType="BIGINT" property="processinstanceid" />
    <result column="type" jdbcType="INTEGER" property="type" />
    <result column="approve" jdbcType="INTEGER" property="approve" />
    <result column="memo" jdbcType="VARCHAR" property="memo" />
    <result column="MTime" jdbcType="TIMESTAMP" property="mtime" />
    <result column="CTime" jdbcType="TIMESTAMP" property="ctime" />
    <result column="processRemark" jdbcType="VARCHAR" property="processRemark" />
    
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Aug 09 11:00:21 CST 2013.
    -->
    id, taskCode, candidateuser, startTime, endTime, taskName, assignerUmId, assignerName, 
    status, processInstanceId, type, approve, memo, MTime, CTime
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Aug 09 11:00:21 CST 2013.
    -->
    select 
    <include refid="Base_Column_List" />
    from SYS_PROCESS_TASK
    where id = #{id,jdbcType=BIGINT}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Aug 09 11:00:21 CST 2013.
    -->
    delete from SYS_PROCESS_TASK
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="com.td.admin.entity.SysProcessTask" useGeneratedKeys ="true" keyProperty = "id">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Aug 09 11:00:21 CST 2013.
    -->
    insert into SYS_PROCESS_TASK (id, taskCode,candidateuser,
      startTime, endTime, taskName, 
      assignerUmId, assignerName, status, 
      processInstanceId, type, approve, 
      memo, MTime, CTime
      )
    values (#{id,jdbcType=BIGINT}, #{taskcode,jdbcType=VARCHAR}, #{candidateuser,jdbcType=VARCHAR}, 
      #{starttime,jdbcType=TIMESTAMP}, #{endtime,jdbcType=TIMESTAMP}, #{taskname,jdbcType=VARCHAR}, 
      #{assignerumid,jdbcType=VARCHAR}, #{assignername,jdbcType=VARCHAR}, #{status,jdbcType=INTEGER}, 
      #{processinstanceid,jdbcType=BIGINT}, #{type,jdbcType=INTEGER}, #{approve,jdbcType=INTEGER}, 
      #{memo,jdbcType=VARCHAR}, #{mtime,jdbcType=TIMESTAMP}, #{ctime,jdbcType=TIMESTAMP}
      )
  </insert>
  <insert id="insertSelective" parameterType="com.td.admin.entity.SysProcessTask" useGeneratedKeys ="true" keyProperty = "id">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Aug 09 11:00:21 CST 2013.
    -->
    insert into SYS_PROCESS_TASK
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="id != null">
        id,
      </if>
      <if test="taskcode != null">
        taskCode,
      </if>
      <if test="candidateuser != null">
        candidateuser,
      </if>
      <if test="starttime != null">
        startTime,
      </if>
      <if test="endtime != null">
        endTime,
      </if>
      <if test="taskname != null">
        taskName,
      </if>
      <if test="assignerumid != null">
        assignerUmId,
      </if>
      <if test="assignername != null">
        assignerName,
      </if>
      <if test="status != null">
        status,
      </if>
      <if test="processinstanceid != null">
        processInstanceId,
      </if>
      <if test="type != null">
        type,
      </if>
      <if test="approve != null">
        approve,
      </if>
      <if test="memo != null">
        memo,
      </if>
      <if test="mtime != null">
        MTime,
      </if>
      <if test="ctime != null">
        CTime,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="id != null">
        #{id,jdbcType=BIGINT},
      </if>
      <if test="taskcode != null">
        #{taskcode,jdbcType=VARCHAR},
      </if>
      <if test="candidateuser != null">
        #{candidateuser,jdbcType=VARCHAR},
      </if>
      <if test="starttime != null">
        #{starttime,jdbcType=TIMESTAMP},
      </if>
      <if test="endtime != null">
        #{endtime,jdbcType=TIMESTAMP},
      </if>
      <if test="taskname != null">
        #{taskname,jdbcType=VARCHAR},
      </if>
      <if test="assignerumid != null">
        #{assignerumid,jdbcType=VARCHAR},
      </if>
      <if test="assignername != null">
        #{assignername,jdbcType=VARCHAR},
      </if>
      <if test="status != null">
        #{status,jdbcType=INTEGER},
      </if>
      <if test="processinstanceid != null">
        #{processinstanceid,jdbcType=BIGINT},
      </if>
      <if test="type != null">
        #{type,jdbcType=INTEGER},
      </if>
      <if test="approve != null">
        #{approve,jdbcType=INTEGER},
      </if>
      <if test="memo != null">
        #{memo,jdbcType=VARCHAR},
      </if>
      <if test="mtime != null">
        #{mtime,jdbcType=TIMESTAMP},
      </if>
      <if test="ctime != null">
        #{ctime,jdbcType=TIMESTAMP},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.td.admin.entity.SysProcessTask">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Aug 09 11:00:21 CST 2013.
    -->
    update SYS_PROCESS_TASK
    <set>
      <if test="taskcode != null">
        taskCode = #{taskcode,jdbcType=VARCHAR},
      </if>
      <if test="candidateuser != null">
        candidateuser = #{candidateuser,jdbcType=VARCHAR},
      </if>
      <if test="starttime != null">
        startTime = #{starttime,jdbcType=TIMESTAMP},
      </if>
      <if test="endtime != null">
        endTime = #{endtime,jdbcType=TIMESTAMP},
      </if>
      <if test="taskname != null">
        taskName = #{taskname,jdbcType=VARCHAR},
      </if>
      <if test="assignerumid != null">
        assignerUmId = #{assignerumid,jdbcType=VARCHAR},
      </if>
      <if test="assignername != null">
        assignerName = #{assignername,jdbcType=VARCHAR},
      </if>
      <if test="status != null">
        status = #{status,jdbcType=INTEGER},
      </if>
      <if test="processinstanceid != null">
        processInstanceId = #{processinstanceid,jdbcType=BIGINT},
      </if>
      <if test="type != null">
        type = #{type,jdbcType=INTEGER},
      </if>
      <if test="approve != null">
        approve = #{approve,jdbcType=INTEGER},
      </if>
      <if test="memo != null">
        memo = #{memo,jdbcType=VARCHAR},
      </if>
      <if test="mtime != null">
        MTime = #{mtime,jdbcType=TIMESTAMP},
      </if>
      <if test="ctime != null">
        CTime = #{ctime,jdbcType=TIMESTAMP},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.td.admin.entity.SysProcessTask">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Aug 09 11:00:21 CST 2013.
    -->
    update SYS_PROCESS_TASK
    set taskCode = #{taskcode,jdbcType=VARCHAR},
      candidateuser = #{candidateuser,jdbcType=VARCHAR},
      startTime = #{starttime,jdbcType=TIMESTAMP},
      endTime = #{endtime,jdbcType=TIMESTAMP},
      taskName = #{taskname,jdbcType=VARCHAR},
      assignerUmId = #{assignerumid,jdbcType=VARCHAR},
      assignerName = #{assignername,jdbcType=VARCHAR},
      status = #{status,jdbcType=INTEGER},
      processInstanceId = #{processinstanceid,jdbcType=BIGINT},
      type = #{type,jdbcType=INTEGER},
      approve = #{approve,jdbcType=INTEGER},
      memo = #{memo,jdbcType=VARCHAR},
      MTime = #{mtime,jdbcType=TIMESTAMP},
      CTime = #{ctime,jdbcType=TIMESTAMP}
    where id = #{id,jdbcType=BIGINT}
  </update>
  

  
  
  
 <select id="getFinTask" parameterType="java.lang.String" resultMap="BaseResultMap">
 	select <include refid="Base_Column_List" /> from SYS_PROCESS_TASK where taskCode = #{taskcode,jdbcType=VARCHAR}
 </select>
 
 
 																			   
   <select id="queryTaskTotalCount" parameterType="com.td.admin.entity.SysProcessTask" resultType="java.lang.Long">
	select count(1) from SYS_PROCESS_TASK
  	    where 1 = 1 
  	  <if test="taskname != null and taskname !=''" >
        and taskName like CONCAT('%',#{taskname,jdbcType=VARCHAR},'%')
      </if>
      <if test="processname != null and processname !=''" >
        and processInstanceId in (select `id` from SYS_PROCESS_INSTANCE where processname like CONCAT('%',#{processname,jdbcType=VARCHAR},'%'))
      </if>
      <if test="assignername != null and assignername !=''" >
        and assignername like CONCAT('%',#{assignername,jdbcType=VARCHAR},'%')
      </if>
      <if test="status != null" >
        and status = #{status,jdbcType=INTEGER}
      </if>
       <if test="starttime != null">
			and startTime &gt;= #{starttime,jdbcType=TIMESTAMP}
		</if>
		<if test="findStartTime != null">
			and startTime &lt;= date_format(#{findStartTime,jdbcType=TIMESTAMP},'%Y-%c-%d 23:59:59') 
		</if>
		<if test="endtime != null">
			and endtime &gt;= #{endtime,jdbcType=TIMESTAMP}
		</if>
		<if test="findEndTime != null">
			and endtime &lt;= date_format(#{findEndTime,jdbcType=TIMESTAMP},'%Y-%c-%d 23:59:59') 
		</if>
  </select>

  <select id="queryTasks" parameterType="com.td.admin.entity.SysProcessTask" resultMap="BaseResultMap">
	select <include refid="Base_Column_List" />,
	(select processname FROM SYS_PROCESS_INSTANCE where SYS_PROCESS_INSTANCE.id=processInstanceId) as processname,
	(select dicItemValue from SYS_DIC_ITEM where dicId=
		(select `id` from SYS_DIC where name='taskStatus') and dicItemKey=SYS_PROCESS_TASK.`status`) as statusName
	from SYS_PROCESS_TASK
  	    where 1 = 1 
      <if test="taskname != null and taskname !=''" >
        and taskName like CONCAT('%',#{taskname,jdbcType=VARCHAR},'%')
      </if>
      <if test="processname != null and processname !=''" >
        and processInstanceId in (select `id` from SYS_PROCESS_INSTANCE where processname like CONCAT('%',#{processname,jdbcType=VARCHAR},'%'))
      </if>
      <if test="assignername != null and assignername !=''" >
        and assignername like CONCAT('%',#{assignername,jdbcType=VARCHAR},'%')
      </if>
      <if test="status != null" >
        and status = #{status,jdbcType=INTEGER}
      </if>
     	 <if test="starttime != null">
			and startTime &gt;= #{starttime,jdbcType=TIMESTAMP}
		</if>
		<if test="findStartTime != null">
			and startTime &lt;= date_format(#{findStartTime,jdbcType=TIMESTAMP},'%Y-%c-%d 23:59:59') 
		</if>
		<if test="endtime != null">
			and endtime &gt;= #{endtime,jdbcType=TIMESTAMP}
		</if>
		<if test="findEndTime != null">
			and endtime &lt;= date_format(#{findEndTime,jdbcType=TIMESTAMP},'%Y-%c-%d 23:59:59') 
		</if>
		<if test="processinstanceid != null" >
         and processInstanceid = #{processinstanceid,jdbcType=INTEGER}
        </if>
		order by status desc, starttime desc
      <if test="beginIndex!=null">
      	limit #{beginIndex,jdbcType=BIGINT},#{numPerPage,jdbcType=BIGINT}
	  </if>
  </select>
    <select id="selectTasks" parameterType="com.td.admin.entity.SysProcessTask" resultMap="BaseResultMap">
	(select <include refid="Base_Column_List" />,
	(select processname FROM SYS_PROCESS_INSTANCE where SYS_PROCESS_INSTANCE.id=processInstanceId) as processname,
	(select dicItemValue from SYS_DIC_ITEM where dicId=
		(select `id` from SYS_DIC where name='taskStatus') and dicItemKey=SYS_PROCESS_TASK.`status`) as statusName
	from SYS_PROCESS_TASK
  	    where endtime is not null
      <if test="taskname != null and taskname !=''" >
        and taskName like CONCAT('%',#{taskname,jdbcType=VARCHAR},'%')
      </if>
      <if test="processname != null and processname !=''" >
        and processInstanceId in (select `id` from SYS_PROCESS_INSTANCE where processname like CONCAT('%',#{processname,jdbcType=VARCHAR},'%'))
      </if>
      <if test="assignername != null and assignername !=''" >
        and assignername like CONCAT('%',#{assignername,jdbcType=VARCHAR},'%')
      </if>
      <if test="status != null" >
        and status = #{status,jdbcType=INTEGER}
      </if>
     	 <if test="starttime != null">
			and startTime &gt;= #{starttime,jdbcType=TIMESTAMP}
		</if>
		<if test="findStartTime != null">
			and startTime &lt;= date_format(#{findStartTime,jdbcType=TIMESTAMP},'%Y-%c-%d 23:59:59') 
		</if>
		<if test="endtime != null">
			and endtime &gt;= #{endtime,jdbcType=TIMESTAMP}
		</if>
		<if test="findEndTime != null">
			and endtime &lt;= date_format(#{findEndTime,jdbcType=TIMESTAMP},'%Y-%c-%d 23:59:59') 
		</if>
		<if test="processinstanceid != null" >
         and processInstanceid = #{processinstanceid,jdbcType=INTEGER}
        </if>
		order by  endTime asc)
		union all
		(select <include refid="Base_Column_List" />,
	(select processname FROM SYS_PROCESS_INSTANCE where SYS_PROCESS_INSTANCE.id=processInstanceId) as processname,
	(select dicItemValue from SYS_DIC_ITEM where dicId=
		(select `id` from SYS_DIC where name='taskStatus') and dicItemKey=SYS_PROCESS_TASK.`status`) as statusName
	from SYS_PROCESS_TASK
  	    where endtime is null
      <if test="taskname != null and taskname !=''" >
        and taskName like CONCAT('%',#{taskname,jdbcType=VARCHAR},'%')
      </if>
      <if test="processname != null and processname !=''" >
        and processInstanceId in (select `id` from SYS_PROCESS_INSTANCE where processname like CONCAT('%',#{processname,jdbcType=VARCHAR},'%'))
      </if>
      <if test="assignername != null and assignername !=''" >
        and assignername like CONCAT('%',#{assignername,jdbcType=VARCHAR},'%')
      </if>
      <if test="status != null" >
        and status = #{status,jdbcType=INTEGER}
      </if>
     	 <if test="starttime != null">
			and startTime &gt;= #{starttime,jdbcType=TIMESTAMP}
		</if>
		<if test="findStartTime != null">
			and startTime &lt;= date_format(#{findStartTime,jdbcType=TIMESTAMP},'%Y-%c-%d 23:59:59') 
		</if>
		<if test="endtime != null">
			and endtime &gt;= #{endtime,jdbcType=TIMESTAMP}
		</if>
		<if test="findEndTime != null">
			and endtime &lt;= date_format(#{findEndTime,jdbcType=TIMESTAMP},'%Y-%c-%d 23:59:59') 
		</if>
		<if test="processinstanceid != null" >
         and processInstanceid = #{processinstanceid,jdbcType=INTEGER}
        </if>
		order by  starttime asc,status desc)
  </select>
   <!--
   <select id="queryTasks" parameterType="com.td.admin.entity.SysProcessTask" resultMap="BaseResultMap">
	select ft.id, ft.taskCode, ft.candidateuser, ft.startTime, ft.endTime, ft.taskName, ft.assignerUmId, ft.assignerName, 
    ft.status, ft.processInstanceId, ft.type, ft.approve, ft.memo, ft.MTime, ft.CTime, fp.processname,fp.remark as 
	(select processname FROM SYS_PROCESS_INSTANCE where SYS_PROCESS_INSTANCE.id=processInstanceId) as processname,
	(select dicItemValue from SYS_DIC_ITEM where dicId=
		(select `id` from SYS_DIC where name='taskStatus') and dicItemKey=SYS_PROCESS_TASK.`status`) as statusName
	from SYS_PROCESS_TASK ft
  	    where 1 = 1 
      <if test="taskname != null and taskname !=''" >
        and taskName like CONCAT('%',#{taskname,jdbcType=VARCHAR},'%')
      </if>
      <if test="processname != null and processname !=''" >
        and processInstanceId in (select `id` from SYS_PROCESS_INSTANCE where processname like CONCAT('%',#{processname,jdbcType=VARCHAR},'%'))
      </if>
      <if test="assignername != null and assignername !=''" >
        and assignername like CONCAT('%',#{assignername,jdbcType=VARCHAR},'%')
      </if>
      <if test="status != null" >
        and status = #{status,jdbcType=INTEGER}
      </if>
     	 <if test="starttime != null">
			and startTime &gt;= #{starttime,jdbcType=TIMESTAMP}
		</if>
		<if test="findStartTime != null">
			and startTime &lt;= date_format(#{findStartTime,jdbcType=TIMESTAMP},'%Y-%c-%d 23:59:59') 
		</if>
		<if test="endtime != null">
			and endtime &gt;= #{endtime,jdbcType=TIMESTAMP}
		</if>
		<if test="findEndTime != null">
			and endtime &lt;= date_format(#{findEndTime,jdbcType=TIMESTAMP},'%Y-%c-%d 23:59:59') 
		</if>
		<if test="processinstanceid != null" >
         and processInstanceid = #{processinstanceid,jdbcType=INTEGER}
        </if>
		order by starttime desc
      <if test="beginIndex!=null">
      	limit #{beginIndex,jdbcType=BIGINT},#{numPerPage,jdbcType=BIGINT}
	  </if>
  </select>
  -->
  <update id="stopTasks" parameterType="com.td.admin.entity.SysProcessTask">
	 update SYS_PROCESS_TASK
    	set status = #{status,jdbcType=INTEGER},
    	endTime = #{endtime,jdbcType=TIMESTAMP},
        memo = #{memo,jdbcType=VARCHAR}
    where processInstanceId = #{processinstanceid,jdbcType=BIGINT} and status = 1
  </update>
  
  <select id="findByOvertime" resultMap="BaseResultMap">
  	select ft.*,ftc.id as taskConfigId from SYS_PROCESS_TASK ft LEFT JOIN SYS_PROCESS_TASK_CONFIG ftc ON ft.taskCode = ftc.`code` and 
	(select processCode from SYS_PROCESS_INSTANCE where id=ft.processInstanceId) = 
	(select `code` from SYS_PROCESS_CONFIG where id=ftc.processConfigId)
	LEFT JOIN SYS_PROCESS_CONFIG fpc ON fpc.id=ftc.processConfigId
	where ftc.timeoutRemindFlag = 1 and ft.status = 1 and
	(
		(ft.lastRemindTime is null and ftc.timeout is not null and ftc.timeout>0 and UNIX_TIMESTAMP(ft.CTime)+ftc.timeout*24*3600+
		(select count(1) from FIN_CALENDER fc where fc.type='2' and fc.date>ft.CTime and fc.date&lt;now())*24*3600
		&lt;UNIX_TIMESTAMP())
	OR
		(ft.lastRemindTime is null and UNIX_TIMESTAMP(ft.CTime)+fpc.defaultTaskTimeout*24*3600+
		(select count(1) from FIN_CALENDER fc where fc.type='2' and fc.date>ft.CTime and fc.date&lt;now())*24*3600
		&lt;UNIX_TIMESTAMP())
	OR
		(ft.lastRemindTime is not null and ftc.remindInterval is not null and ftc.remindInterval>0 and UNIX_TIMESTAMP(ft.lastRemindTime)+ftc.remindInterval*24*3600+
		(select count(1) from FIN_CALENDER fc where fc.type='2' and fc.date>ft.lastRemindTime and fc.date&lt;now())*24*3600
		&lt;UNIX_TIMESTAMP())
	OR
		(ft.lastRemindTime is not null and UNIX_TIMESTAMP(ft.lastRemindTime)+fpc.defaultRemindInterval*24*3600+
		(select count(1) from FIN_CALENDER fc where fc.type='2' and fc.date>ft.lastRemindTime and fc.date&lt;now())*24*3600
		&lt;UNIX_TIMESTAMP())
	)
  </select>
  
  <select id="queryMyCompleteFinTaskCount" parameterType="java.util.Map" resultType="java.lang.Long">
  	 select count(1) from SYS_PROCESS_TASK ft left join SYS_PROCESS_INSTANCE AS fp on (ft.processInstanceId = fp.id) 
  	 		left join SYS_PROCESS_CONFIG AS fpc 
  		   	on( fp.processCode = fpc.`code` ) 
		    left join SYS_PROCESS_TASK_CONFIG AS ftc on 
		    (fpc.id = ftc.processConfigId and ftc.`code` = ft.taskCode) 
  	 		where ft.status in (2, 3, 4) and ft.assignerUmId = #{userId,jdbcType=VARCHAR}
  	 	<if test="processName != null and processName!=''">
			and  fp.processName like CONCAT('%',#{processName,jdbcType=VARCHAR},'%')
		</if>
		<if test="taskName != null and taskName != ''">
			and  ft.taskName like CONCAT('%',#{taskName,jdbcType=VARCHAR},'%')
		</if>
		<if test="sheetId != null and sheetId != ''">
			and  ft.taskName like CONCAT('%',#{sheetId,jdbcType=VARCHAR},'%')
		</if>
		<if test="starterName != null and starterName !=''">
			and  fp.starterName like CONCAT('%',#{starterName,jdbcType=VARCHAR},'%') 
		</if>
		<if test="startTime != null and startTime !=''">
			and ft.endTime &gt;= date_format(#{startTime,jdbcType=TIMESTAMP},'%Y-%c-%d 00:00:00') 
		</if>
		<if test="endTime != null and endTime !=''">
			and ft.endTime &lt;= date_format(#{endTime,jdbcType=TIMESTAMP},'%Y-%c-%d 23:59:59') 
		</if>
  </select>
  
  <select id="queryMyCompleteFinTask" parameterType="java.util.Map" resultType="java.util.Map">
   select  ft.id as id,ft.taskName as taskname,ft.startTime as starttime,ft.endTime as endtime,ft.type as type,fp.sheetType as sheetType,fp.sheetId as sheetId,fp.startTime as fpSartTime,fp.endTime as piendtime,fp.status as pis,fp.currentTaskName as currenttaskname,fp.processName as processname,fp.starterName as startusername, ft.taskCode as taskcode,ft.processInstanceId as processInstanceId, fp.processCode as processcode, ft.status as status, ft.memo,fp.starterName as starterName, fp.assigneeName as assigneeName 
  	,fp.remark as processRemark from SYS_PROCESS_TASK ft left join SYS_PROCESS_INSTANCE AS fp on (ft.processInstanceId = fp.id)
  			left join SYS_PROCESS_CONFIG AS fpc 
  		   	on( fp.processCode = fpc.`code` ) 
		    left join SYS_PROCESS_TASK_CONFIG AS ftc on 
		    (fpc.id = ftc.processConfigId and ftc.`code` = ft.taskCode) 
  	 	 	where ft.status in (2, 3, 4) and ft.assignerUmId = #{userId,jdbcType=VARCHAR} 
  	 	 	<if test="processName != null and processName!=''">
				and  fp.processName like CONCAT('%',#{processName,jdbcType=VARCHAR},'%')
			</if>
			<if test="taskName != null and taskName != ''">
				and  ft.taskName like CONCAT('%',#{taskName,jdbcType=VARCHAR},'%')
			</if>
			<if test="sheetId != null and sheetId != ''">
				and  ft.taskName like CONCAT('%',#{sheetId,jdbcType=VARCHAR},'%')
			</if>
			<if test="starterName != null and starterName !=''">
				and  fp.starterName like CONCAT('%',#{starterName,jdbcType=VARCHAR},'%') 
			</if>
			<if test="startTime != null and startTime !=''">
				and ft.endTime &gt;= date_format(#{startTime,jdbcType=TIMESTAMP},'%Y-%c-%d 00:00:00') 
			</if>
			<if test="endTime != null and endTime !=''">
				and ft.endTime &lt;= date_format(#{endTime,jdbcType=TIMESTAMP},'%Y-%c-%d 23:59:59') 
			</if>
  	 	 	order by ft.CTime desc
  			limit #{beginIndex,jdbcType=BIGINT},#{numPerPage,jdbcType=BIGINT}
  </select>
  
  <select id="queryMyFinTaskCount" parameterType="com.td.admin.entity.SysProcessTask" resultType="java.lang.Long">
  	select count(1) from ( 
  		select fp.id as processInstanceId,fp.processName as processname,fp.processCode as processcode,ft.id as id,fp.starterName as startusername, fp.startTime as fpSartTime, ft.taskCode as taskcode,ft.taskname as taskname,ft.startTime as starttime,fp.sheetId as sheetId,fp.sheetType as sheetType, ft.memo,
  		   ft.assignerUmId as assignerumid,ft.assignerName as assignername,ft.type as type,CONCAT(",",ft.candidateUser,",") as candidateUser,ft.status as status,ft.CTime as CTime from SYS_PROCESS_TASK as ft left join SYS_PROCESS_INSTANCE as fp 
  		   on( 
  		   		ft.processInstanceId = fp.id
  		   		<if test="startername!=null and startername!=''">
  		   			<!--  and fp.starterName = #{startername,jdbcType=VARCHAR}-->
  		   		</if> 
  		   	 )
  		   left join SYS_PROCESS_CONFIG AS fpc 
  		   on(
  		   		fp.processCode = fpc.`code`
  		   	 ) 
		   left join SYS_PROCESS_TASK_CONFIG AS ftc on 
		   (
		   		fpc.id = ftc.processConfigId 
		   		and ftc.`code` = ft.taskCode
		   ) 
	) as finTask
  	where finTask.status = 1 
  	<if test="processname!=null and processname!=''">
		and finTask.processName like CONCAT('%',#{processname,jdbcType=VARCHAR},'%')
  	</if>
  	<if test="id != null">
		and finTask.id = #{id,jdbcType=BIGINT}
  	</if>
  	<if test="taskname!=null and taskname!=''">
  		and finTask.taskName like CONCAT('%',#{taskname,jdbcType=VARCHAR},'%')
  	</if>
  	<if test="sheetId!=null and sheetId!=''">
  		and finTask.taskName like CONCAT('%',#{sheetId,jdbcType=VARCHAR},'%')
  	</if>
  	<if test="startername!=null and startername!=''">
  		  and finTask.startusername like CONCAT('%',#{startername,jdbcType=VARCHAR},'%') 
  	</if> 
  		and (finTask.assignerUmId = #{assignerumid,jdbcType=VARCHAR} or  finTask.assignerUmId = '' or finTask.assignerUmId is null)
  		and finTask.candidateUser like CONCAT('%,',#{assignerumid,jdbcType=VARCHAR},',%')
  </select>
  
  <select id="queryMyFinTask" parameterType="java.util.Map" resultType="java.util.Map">
  	select * from ( 
  	select fp.status as freezeStatus,fp.id as processInstanceId,fp.processName as processname,fp.remark as processRemark,fp.processCode as processcode,ft.id as id,fp.starterName as startusername, fp.startTime as fpSartTime, ft.taskCode as taskcode,ft.taskname as taskname,ft.startTime as starttime,fp.sheetId as sheetId,fp.sheetType as sheetType, ft.memo,
  		   ft.assignerUmId as assignerumid,ft.assignerName as assignername,ft.type as type,CONCAT(",",ft.candidateUser,",") as candidateUser,ft.status as status,ft.CTime as CTime from SYS_PROCESS_TASK as ft left join SYS_PROCESS_INSTANCE as fp 
  		   on( 
  		   		ft.processInstanceId = fp.id
  		   		<if test="startername!=null and startername!=''">
  		   			<!--  and fp.starterName = #{startername,jdbcType=VARCHAR}-->
  		   		</if> 
  		   	 )
  		   left join SYS_PROCESS_CONFIG AS fpc 
  		   on(
  		   		fp.processCode = fpc.`code`
  		   	 ) 
		   left join SYS_PROCESS_TASK_CONFIG AS ftc on 
		   (
		   		fpc.id = ftc.processConfigId 
		   		and ftc.`code` = ft.taskCode
		   ) 
	) as finTask
  	where finTask.status = 1 
  	<if test="processname!=null and processname!=''">
		and finTask.processName like CONCAT('%',#{processname,jdbcType=VARCHAR},'%')
  	</if>
  	<if test="id != null">
		and finTask.id = #{id,jdbcType=BIGINT}
  	</if>
  	<if test="taskname!=null and taskname!=''">
  		and finTask.taskName like CONCAT('%',#{taskname,jdbcType=VARCHAR},'%')
  	</if>
  	<if test="sheetId!=null and sheetId!=''">
  		and finTask.taskName like CONCAT('%',#{sheetId,jdbcType=VARCHAR},'%')
  	</if>
  	<if test="startername!=null and startername!=''">
  		  and finTask.startusername like CONCAT('%',#{startername,jdbcType=VARCHAR},'%') 
  	</if> 
  		and (finTask.assignerUmId = #{assignerumid,jdbcType=VARCHAR} or  finTask.assignerUmId = '' or finTask.assignerUmId is null)
  		and finTask.candidateUser like CONCAT('%,',#{assignerumid,jdbcType=VARCHAR},',%')	
  		order by finTask.CTime desc limit #{beginIndex,jdbcType=BIGINT},#{numPerPage,jdbcType=BIGINT}
  </select>

	<select id="queryMyVerifyingTaskCount" parameterType="com.td.admin.entity.SysProcessTask" resultType="java.lang.Long">
  	select count(1) from ( 
  		select fp.id as processInstanceId,fp.processName as processname,fp.processCode as processcode,ft.id as id,fp.starterName as startusername, fp.startTime as fpSartTime, ft.taskCode as taskcode,ft.taskname as taskname,ft.startTime as starttime,fp.sheetId as sheetId,fp.sheetType as sheetType, ft.memo,
  		   ft.assignerUmId as assignerumid,ft.assignerName as assignername,ft.type as type,CONCAT(",",ft.candidateUser,",") as candidateUser,ft.status as status,ft.CTime as CTime from SYS_PROCESS_TASK as ft left join SYS_PROCESS_INSTANCE as fp 
  		   on( 
  		   		ft.processInstanceId = fp.id
  		   		<if test="startername!=null and startername!=''">
  		   			<!--  and fp.starterName = #{startername,jdbcType=VARCHAR}-->
  		   		</if> 
  		   	 )
  		   left join SYS_PROCESS_CONFIG AS fpc 
  		   on(
  		   		fp.processCode = fpc.`code`
  		   	 ) 
		   left join SYS_PROCESS_TASK_CONFIG AS ftc on 
		   (
		   		fpc.id = ftc.processConfigId 
		   		and ftc.`code` = ft.taskCode
		   ) 
	) as finTask
  	where finTask.status = 5 
  	<if test="processname!=null and processname!=''">
		and finTask.processName like CONCAT('%',#{processname,jdbcType=VARCHAR},'%')
  	</if>
  	<if test="taskname!=null and taskname!=''">
  		and finTask.taskName like CONCAT('%',#{taskname,jdbcType=VARCHAR},'%')
  	</if>
  	<if test="sheetId!=null and sheetId!=''">
  		and finTask.taskName like CONCAT('%',#{sheetId,jdbcType=VARCHAR},'%')
  	</if>
  	<if test="startername!=null and startername!=''">
  		  and finTask.startusername like CONCAT('%',#{startername,jdbcType=VARCHAR},'%') 
  	</if> 
  		and (finTask.assignerUmId = #{assignerumid,jdbcType=VARCHAR} or  finTask.assignerUmId = '' or finTask.assignerUmId is null)
  		and finTask.candidateUser like CONCAT('%,',#{assignerumid,jdbcType=VARCHAR},',%')	
  </select>
  
  <select id="queryMyVerifyingTask" parameterType="java.util.Map" resultType="java.util.Map">
  	select * from ( 
  	select fp.id as processInstanceId,fp.processName as processname,fp.remark as processRemark,fp.processCode as processcode,ft.id as id,fp.starterName as startusername, fp.startTime as fpSartTime, ft.taskCode as taskcode,ft.taskname as taskname,ft.startTime as starttime,fp.sheetId as sheetId,fp.sheetType as sheetType, ft.memo,
  		   ft.assignerUmId as assignerumid,ft.assignerName as assignername,ft.type as type,CONCAT(",",ft.candidateUser,",") as candidateUser,ft.status as status,ft.CTime as CTime from SYS_PROCESS_TASK as ft left join SYS_PROCESS_INSTANCE as fp 
  		   on( 
  		   		ft.processInstanceId = fp.id
  		   		<if test="startername!=null and startername!=''">
  		   			<!--  and fp.starterName = #{startername,jdbcType=VARCHAR}-->
  		   		</if> 
  		   	 )
  		   left join SYS_PROCESS_CONFIG AS fpc 
  		   on(
  		   		fp.processCode = fpc.`code`
  		   	 ) 
		   left join SYS_PROCESS_TASK_CONFIG AS ftc on 
		   (
		   		fpc.id = ftc.processConfigId 
		   		and ftc.`code` = ft.taskCode
		   ) 
	) as finTask
  	where finTask.status = 5 
  	<if test="processname!=null and processname!=''">
		and finTask.processName like CONCAT('%',#{processname,jdbcType=VARCHAR},'%')
  	</if>
  	<if test="taskname!=null and taskname!=''">
  		and finTask.taskName like CONCAT('%',#{taskname,jdbcType=VARCHAR},'%')
  	</if>
  	<if test="sheetId!=null and sheetId!=''">
  		and finTask.taskName like CONCAT('%',#{sheetId,jdbcType=VARCHAR},'%')
  	</if>
  	<if test="startername!=null and startername!=''">
  		  and finTask.startusername like CONCAT('%',#{startername,jdbcType=VARCHAR},'%') 
  	</if> 
  		and (finTask.assignerUmId = #{assignerumid,jdbcType=VARCHAR} or  finTask.assignerUmId = '' or finTask.assignerUmId is null)
  		and finTask.candidateUser like CONCAT('%,',#{assignerumid,jdbcType=VARCHAR},',%')	
  		order by finTask.CTime desc limit #{beginIndex,jdbcType=BIGINT},#{numPerPage,jdbcType=BIGINT}
  </select>
  
  <select id="getTasksByProcessInstanceIdAndTaskCode" parameterType="com.td.admin.entity.SysProcessTask" resultMap="BaseResultMap">
    select 
    <include refid="Base_Column_List" />
    from SYS_PROCESS_TASK
    where processInstanceId = #{processinstanceid,jdbcType=BIGINT}
      and taskCode = #{taskcode,jdbcType=VARCHAR}
  </select>
  <select id="queryTaskByTaskCode" parameterType="com.td.admin.entity.SysProcessTask" resultMap="BaseResultMap">
	select <include refid="Base_Column_List" />
	from SYS_PROCESS_TASK where 1 = 1 
      <if test="taskname != null and taskname !=''" >
        and taskname  like CONCAT('%',#{taskname,jdbcType=VARCHAR},'%')
      </if>
      <if test="taskcode != null">
        and taskCode = #{taskcode,jdbcType=VARCHAR}
      </if>
		order by id asc
  </select>
  
  <update id="updateLastReminderTime" parameterType="java.lang.Long" >
    update SYS_PROCESS_TASK
    set lastRemindTime = now()
    where id = #{id,jdbcType=BIGINT}
  </update>
</mapper>